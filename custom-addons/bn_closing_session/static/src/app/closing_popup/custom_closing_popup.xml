<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <!-- Responsive Closing Popup Component -->
    <t t-name="CustomClosingPopup" owl="1">
        <div class="popup close-pos-popup modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <!-- Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Closing Session</h4>
                    <div class="total-orders fw-bolder ms-3">
                        Total <t t-esc="props.orders_details.quantity"/> orders:
                        <span class="amount" t-esc="env.utils.formatCurrency(props.orders_details.amount)"/>
                    </div>
                </div>

                <!-- Body -->
                <main class="modal-body p-2" style="max-height: 70vh; overflow-y: auto;">
                    <div class="payment-methods-overview table-responsive">
                        <table class="table table-sm table-bordered table-striped text-start mb-0">
                            <thead class="table-light">
                                <tr class="text-dark">
                                    <th>Payment Method</th>
                                    <th>Expected</th>
                                    <th t-if="shouldShowSlipHeaders()">Difference</th>
                                    <th>Bank</th>
                                    <th>Slip No.</th>
                                    <th t-if="shouldShowSlipHeaders()">Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>

                            <!-- Default Cash Payment -->
                            <t t-if="pos.config.cash_control">
                                <tbody>
                                    <tr t-key="'default_cash'">
                                        <td t-esc="props.default_cash_details.name"/>
                                        <td t-esc="env.utils.formatCurrency(props.default_cash_details.amount)"/>
                                        <td t-esc="env.utils.formatCurrency(getDifference(props.default_cash_details.id))"
                                            t-att-class="{'text-danger fw-bold': !env.utils.floatIsZero(getDifference(props.default_cash_details.id))}"/>
                                    </tr>
                                </tbody>

                                <!-- Cash Breakdown Rows -->
                                <tbody class="cash-overview small text-muted">
                                    <t t-foreach="['restricted','unrestricted','neutral']" t-as="type" t-key="type">
                                        <tr t-key="props.default_cash_details.id + '-' + type">
                                            <td>
                                                <t t-if="type==='restricted'"><span t-esc="pos.company.restricted_category"/> Amount</t>
                                                <t t-if="type==='unrestricted'"><span t-esc="pos.company.unrestricted_category"/> Amount</t>
                                                <t t-if="type==='neutral'">Non-Donation Amount</t>
                                            </td>
                                            <td t-esc="env.utils.formatCurrency(props.default_cash_details.breakdown[type])"/>
                                            <t t-if="shouldShowSlipInput(props.default_cash_details)">
                                                <td t-esc="env.utils.formatCurrency(
                                                    type==='restricted'?getRestrictedDifference(props.default_cash_details.id):
                                                    type==='unrestricted'?getUnrestrictedDifference(props.default_cash_details.id):
                                                    getNeutralDifference(props.default_cash_details.id)
                                                )"
                                                t-att-class="{'text-danger fw-bold': !env.utils.floatIsZero(
                                                    type==='restricted'?getRestrictedDifference(props.default_cash_details.id):
                                                    type==='unrestricted'?getUnrestrictedDifference(props.default_cash_details.id):
                                                    getNeutralDifference(props.default_cash_details.id)
                                                )}"/>
                                            </t>
                                            <t t-else="">
                                                <td/>
                                            </t>
                                            <td>
                                                <select class="form-select form-select-sm"
                                                    t-model="state.newLines[props.default_cash_details.id][type].bank">
                                                    <option value="0">Select Bank</option>
                                                    <t t-foreach="props.bank_list" t-as="bank" t-key="bank.id">
                                                        <option t-att-value="bank.id"><t t-esc="bank.name"/></option>
                                                    </t>
                                                </select>
                                            </td>
                                            <td>
                                                <input class="form-control form-control-sm" placeholder="Slip No."
                                                    t-model="state.newLines[props.default_cash_details.id][type].ref"/>
                                            </td>
                                            <!-- Amount column only if header exists -->
                                            <t t-if="shouldShowSlipHeaders()">
                                                <td>
                                                    <t t-if="shouldShowSlipInput(props.default_cash_details)">
                                                        <input class="form-control form-control-sm" placeholder="Amount"
                                                            t-model="state.newLines[props.default_cash_details.id][type].amount"/>
                                                    </t>
                                                </td>
                                            </t>
                                            <td class="text-center">
                                                <button class="btn btn-secondary btn-sm"
                                                    t-on-click="() => handleAddLine(props.default_cash_details.id,type)">➕</button>
                                            </td>
                                        </tr>

                                        <tr t-foreach="state.lines[props.default_cash_details.id][type]||[]" t-as="line" t-key="line.id">
                                            <t t-if="shouldShowSlipInput(props.default_cash_details)">
                                                <td colspan="3">----</td>
                                            </t>
                                            <t t-else="">
                                                <td colspan="2">----</td>
                                            </t>
                                            <td t-esc="line?.bank||''"/>
                                            <td t-esc="line?.ref||''"/>
                                            <!-- Amount column only if header exists -->
                                            <t t-if="shouldShowSlipHeaders()">
                                                <td t-if="shouldShowSlipInput(props.default_cash_details)" t-esc="formatCurrencyNeutral(line?.amount)"/>
                                            </t>
                                            <td class="text-center">
                                                <button class="btn btn-danger btn-sm"
                                                    t-on-click="() => handleRemoveLine(props.default_cash_details.id,line.id,line.record_id,type)">❌</button>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </t>

                            <!-- Other Payment Methods -->
                            <t t-foreach="props.other_payment_methods" t-as="pm" t-key="pm.id">
                                <tbody>
                                    <tr>
                                        <td t-esc="pm.name"/>
                                        <td t-esc="env.utils.formatCurrency(pm.amount)"/>
                                        <td t-esc="env.utils.formatCurrency(getDifference(pm.id))"
                                            t-att-class="{'text-danger fw-bold': !env.utils.floatIsZero(getDifference(pm.id))}"/>
                                    </tr>
                                </tbody>

                                <tbody class="cash-overview small text-muted">
                                    <t t-foreach="['restricted','unrestricted','neutral']" t-as="type" t-key="type">
                                        <tr t-key="pm.id+'-'+type">
                                            <td>
                                                <t t-if="type==='restricted'"><span t-esc="pos.company.restricted_category"/> Amount</t>
                                                <t t-if="type==='unrestricted'"><span t-esc="pos.company.unrestricted_category"/> Amount</t>
                                                <t t-if="type==='neutral'">Non-Donation Amount</t>
                                            </td>
                                            <td t-esc="env.utils.formatCurrency(pm.breakdown[type])"/>
                                            <t t-if="shouldShowSlipInput(pm)">
                                                <td t-esc="env.utils.formatCurrency(
                                                    type==='restricted'?getRestrictedDifference(pm.id):
                                                    type==='unrestricted'?getUnrestrictedDifference(pm.id):
                                                    getNeutralDifference(pm.id)
                                                )"
                                                t-att-class="{'text-danger fw-bold': !env.utils.floatIsZero(
                                                    type==='restricted'?getRestrictedDifference(pm.id):
                                                    type==='unrestricted'?getUnrestrictedDifference(pm.id):
                                                    getNeutralDifference(pm.id)
                                                )}"/>
                                            </t>
                                            <t t-else="">
                                                <td/>
                                            </t>
                                            <td>
                                                <select class="form-select form-select-sm"
                                                    t-model="state.newLines[pm.id][type].bank">
                                                    <option value="0">Select Bank</option>
                                                    <t t-foreach="props.bank_list" t-as="bank" t-key="bank.id">
                                                        <option t-att-value="bank.id"><t t-esc="bank.name"/></option>
                                                    </t>
                                                </select>
                                            </td>
                                            <td>
                                                <input class="form-control form-control-sm" placeholder="Slip No."
                                                    t-model="state.newLines[pm.id][type].ref"/>
                                            </td>
                                            <!-- Amount column only if header exists -->
                                            <t t-if="shouldShowSlipHeaders()">
                                                <td>
                                                    <t t-if="shouldShowSlipInput(pm)">
                                                        <input class="form-control form-control-sm" placeholder="Amount"
                                                            t-model="state.newLines[pm.id][type].amount"/>
                                                    </t>
                                                </td>
                                            </t>
                                            <td class="text-center">
                                                <button class="btn btn-secondary btn-sm"
                                                    t-on-click="() => handleAddLine(pm.id,type)">➕</button>
                                            </td>
                                        </tr>

                                        <tr t-foreach="state.lines[pm.id][type]||[]" t-as="line" t-key="line.id">
                                            <t t-if="shouldShowSlipInput(pm)">
                                                <td colspan="3">----</td>
                                            </t>
                                            <t t-else="">
                                                <td colspan="2">----</td>
                                            </t>
                                            <td t-esc="line?.bank||''"/>
                                            <td t-esc="line?.ref||''"/>
                                            <!-- Amount column only if header exists -->
                                            <t t-if="shouldShowSlipHeaders()">
                                                <td t-if="shouldShowSlipInput(pm)" t-esc="formatCurrencyNeutral(line?.amount)"/>
                                            </t>
                                            <td class="text-center">
                                                <button class="btn btn-danger btn-sm"
                                                    t-on-click="() => handleRemoveLine(pm.id,line.id,line.record_id,type)">❌</button>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </t>
                        </table>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-container d-flex flex-column flex-md-row gap-2 border-top mt-3 pt-2">
                        <div class="opening-notes flex-grow-1" t-if="props.opening_notes">
                            <label class="form-label">Opening note</label>
                            <textarea class="form-control form-control-sm" readonly="readonly" t-esc="props.opening_notes"/>
                        </div>
                        <div class="closing-notes flex-grow-1">
                            <label class="form-label">Closing note</label>
                            <textarea class="form-control form-control-sm" placeholder="Add a closing note..." t-model="state.notes"/>
                        </div>
                    </div>
                </main>

                <!-- Footer -->
                <footer class="modal-footer d-flex justify-content-between">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" t-att-disabled="!canConfirm()" t-on-click="confirm">Close Session</button>
                        <button class="btn btn-secondary" t-att-disabled="!canCancel()" t-on-click="cancel">Discard</button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary" t-on-click="downloadSalesReport" title="Download Daily Sale Report">
                            Daily Sale <i class="fa fa-download"/>
                        </button>
                        <button t-if="hardwareProxy.printer" class="btn btn-secondary">
                            <SaleDetailsButton/>
                        </button>
                    </div>
                </footer>
            </div>
        </div>
    </t>

</templates>
