name: Deploy UAT (Odoo)

on:
  push:
    branches: [ main ]          # main par push hote hi deploy
  workflow_dispatch:             # manual run button

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Setup SSH
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${DEPLOY_SSH_PORT:-22}" "$DEPLOY_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Rsync custom-addons to server (/opt/swituat/custom-addons/)
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
        run: |
          # Repo me addons yahin par hain:
          SRC="custom-addons/"
          if [ ! -d "$SRC" ]; then
            echo "custom-addons/ not found at repo root; syncing full repo as fallback"
            SRC="./"
          fi

          TARGET_DIR="/opt/swituat/custom-addons/"
          RSYNC_RSH="ssh -p ${DEPLOY_SSH_PORT:-22}"
          rsync -avz --delete \
            --exclude=".git" --exclude=".github" \
            -e "$RSYNC_RSH" \
            "$SRC" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:${TARGET_DIR}"

      - name: Fix perms, optional deps, optional module update, restart Odoo
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          ODOO_SERVICE: ${{ secrets.ODOO_SERVICE }}
          ODOO_CONFIG_PATH: ${{ secrets.ODOO_CONFIG_PATH }}
          UAT_DB_NAME: ${{ secrets.UAT_DB_NAME }}
        run: |
          ssh -p "${DEPLOY_SSH_PORT:-22}" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" bash -lc '
            set -e
            # 1) perms
            chown -R root:root /opt/swituat/custom-addons

            # 2) optional python deps (if file present)
            if [ -f /opt/swituat/custom-addons/requirements.txt ]; then
              pip3 install -r /opt/swituat/custom-addons/requirements.txt
            fi

            # 3) optional module update (keep empty to skip)
            # Example: AUTO_UPDATE="module_one,module_two"
            AUTO_UPDATE=""
            if [ -n "$AUTO_UPDATE" ]; then
              /usr/bin/odoo -c "${ODOO_CONFIG_PATH:-/etc/swituat.conf}" -d "${UAT_DB_NAME}" -u "$AUTO_UPDATE" --stop-after-init
            fi

            # 4) restart odoo
            systemctl restart "${ODOO_SERVICE}"
            systemctl is-active "${ODOO_SERVICE}"
          '
