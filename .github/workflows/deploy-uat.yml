name: Deploy UAT (Odoo)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Get Runner Public IP (For Firewall Debugging)
        run: |
          echo "--------------------------------------------------"
          echo "GITHUB RUNNER PUBLIC IP:"
          curl -s https://ifconfig.me/ || echo "Failed to get IP"
          echo ""
          echo "--------------------------------------------------"
          echo "If this fails, check '/var/log/fail2ban.log' on your server for this IP."

      - name: Setup SSH (Trust Host)
        env:
          DEPLOY_SSH_KEY_B64: ${{ secrets.DEPLOY_SSH_KEY_B64 }}
          DEPLOY_SSH_HOST:    ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT:    ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          set -euxo pipefail
          mkdir -p "$HOME/.ssh"
          echo "$DEPLOY_SSH_KEY_B64" | base64 -d > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keygen -yf "$HOME/.ssh/id_ed25519" > "$HOME/.ssh/derived.pub"
          
          # Create a config that disables host key checking/hashing for this host
          echo "Host $DEPLOY_SSH_HOST" > "$HOME/.ssh/config"
          echo "  StrictHostKeyChecking no" >> "$HOME/.ssh/config"
          echo "  UserKnownHostsFile=/dev/null" >> "$HOME/.ssh/config"
          echo "  LogLevel ERROR" >> "$HOME/.ssh/config"

      - name: Connectivity Check (Netcat)
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          echo "Attempting TCP connection to $DEPLOY_SSH_HOST on port ${DEPLOY_SSH_PORT:-22}..."
          # -v: verbose, -z: scan mode, -w 10: 10 second timeout
          if nc -v -z -w 10 "$DEPLOY_SSH_HOST" "${DEPLOY_SSH_PORT:-22}"; then
            echo "SUCCESS: Port is open and reachable."
          else
            echo "FAILURE: Port cannot be reached. Connection timed out."
            echo "This confirms a FIREWALL or FAIL2BAN block on the server."
            exit 1
          fi

      - name: Auth probe (publickey only)
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
        run: |
          set -euo pipefail
          # Added ConnectTimeout=60 to handle slow routes
          SSH="env -u SSH_AUTH_SOCK ssh -i $HOME/.ssh/id_ed25519 -p ${DEPLOY_SSH_PORT:-22} -o ConnectTimeout=60 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          $SSH "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" 'echo AUTH_OK'

      - name: Rsync custom-addons â†’ /opt/swituat/custom-addons/
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
        run: |
          set -euo pipefail
          SRC="custom-addons/"
          if [ ! -d "$SRC" ]; then
            echo "custom-addons/ not found at repo root; syncing full repo as fallback"
            SRC="./"
          fi
          SSH="env -u SSH_AUTH_SOCK ssh -i $HOME/.ssh/id_ed25519 -p ${DEPLOY_SSH_PORT:-22} -o ConnectTimeout=60 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          
          $SSH "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" 'command -v rsync >/dev/null 2>&1 || (apt-get update && apt-get install -y rsync); mkdir -p /opt/swituat/custom-addons'
          
          rsync -avz --delete \
            --exclude=".git" --exclude=".github" \
            -e "$SSH" \
            "$SRC" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:/opt/swituat/custom-addons/"

      - name: Fix perms + optional deps + restart Odoo (robust)
        env:
          DEPLOY_SSH_HOST:  ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT:  ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER:  ${{ secrets.DEPLOY_SSH_USER }}
          ODOO_SERVICE:     ${{ secrets.ODOO_SERVICE }}
          ODOO_CONFIG_PATH: ${{ secrets.ODOO_CONFIG_PATH }}
          UAT_DB_NAME:      ${{ secrets.UAT_DB_NAME }}
        run: |
          set -euo pipefail
          SSH="env -u SSH_AUTH_SOCK ssh -i $HOME/.ssh/id_ed25519 -p ${DEPLOY_SSH_PORT:-22} -o ConnectTimeout=60 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

          SERVICE="${ODOO_SERVICE:-swituat.service}"
          CONF="${ODOO_CONFIG_PATH:-/etc/swituat.conf}"
          DB="${UAT_DB_NAME:-remapping-uat}"

          $SSH "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" \
            "SERVICE=\$(printf %s \"$SERVICE\" | tr -d '\r\n\"'); \
             CONF=\$(printf %s \"$CONF\" | tr -d '\r\n\"'); \
             DB=\$(printf %s \"$DB\" | tr -d '\r\n\"'); \
             set -euo pipefail; \
             echo \"[deploy] service=\$SERVICE conf=\$CONF db=\$DB\"; \
             chown -R root:root /opt/swituat/custom-addons; \
             if [ -f /opt/swituat/custom-addons/requirements.txt ]; then pip3 install -r /opt/swituat/custom-addons/requirements.txt; fi; \
             AUTO_UPDATE=\"\"; \
             if [ -n \"\$AUTO_UPDATE\" ]; then /usr/bin/odoo -c \"\$CONF\" -d \"\$DB\" -u \"\$AUTO_UPDATE\" --stop-after-init; fi; \
             systemctl restart \"\$SERVICE\"; \
             systemctl is-active \"\$SERVICE\""
