#TESTING Checking
name: Deploy UAT (Odoo)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
  
      - name: Setup SSH (single key, publickey-only, normalize)
        env:
          DEPLOY_SSH_KEY:  ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
        run: |
          set -e
          mkdir -p "$HOME/.ssh"
          printf "%s" "$DEPLOY_SSH_KEY" > "$HOME/.ssh/id_ed25519"

          # Convert CRLF -> LF to avoid key parse issues
          tr -d '\r' < "$HOME/.ssh/id_ed25519" > "$HOME/.ssh/_tmpkey" && mv "$HOME/.ssh/_tmpkey" "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          # Known hosts
          ssh-keyscan -p "${DEPLOY_SSH_PORT:-22}" "$DEPLOY_SSH_HOST" >> "$HOME/.ssh/known_hosts"

          # SSH config
          printf '%s\n' \
            'Host target' \
            "  HostName ${DEPLOY_SSH_HOST}" \
            "  Port ${DEPLOY_SSH_PORT:-22}" \
            "  User ${DEPLOY_SSH_USER:-root}" \
            '  IdentityFile ~/.ssh/id_ed25519' \
            '  IdentitiesOnly yes' \
            '  PreferredAuthentications publickey' \
            '  PubkeyAuthentication yes' \
            '  PasswordAuthentication no' \
            '  KbdInteractiveAuthentication no' \
            '  StrictHostKeyChecking yes' \
            > "$HOME/.ssh/config"
          chmod 600 "$HOME/.ssh/config"

      - name: Auth probe (publickey only)
        run: |
          set -e
          env -u SSH_AUTH_SOCK ssh -F "$HOME/.ssh/config" \
            -o PreferredAuthentications=publickey \
            -o PasswordAuthentication=no \
            target 'echo AUTH_OK'


      - name: Rsync custom-addons to server (/opt/swituat/custom-addons/)
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
        run: |
          set -e
          SRC="custom-addons/"
          if [ ! -d "$SRC" ]; then
            echo "custom-addons/ not found at repo root; syncing full repo as fallback"
            SRC="./"
          fi

          # Safety: ensure config exists
          if [ ! -f "$HOME/.ssh/config" ]; then
            echo "SSH config missing; recreating..."
            mkdir -p "$HOME/.ssh"
            printf '%s\n' "Host target" "  HostName ${DEPLOY_SSH_HOST}" "  Port ${DEPLOY_SSH_PORT:-22}" "  User ${DEPLOY_SSH_USER:-root}" '  IdentityFile ~/.ssh/id_ed25519' '  IdentitiesOnly yes' '  PreferredAuthentications publickey' '  PubkeyAuthentication yes' '  PasswordAuthentication no' '  KbdInteractiveAuthentication no' '  StrictHostKeyChecking yes' > "$HOME/.ssh/config"
            chmod 600 "$HOME/.ssh/config"
          fi

          # Use $HOME (tilde not expanded inside quotes)
          RSYNC_SSH='env -u SSH_AUTH_SOCK ssh -F '"$HOME"'/.ssh/config target'

          rsync -avz --delete \
            --exclude=".git" --exclude=".github" \
            -e "$RSYNC_SSH" \
            "$SRC" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:/opt/swituat/custom-addons/"

      - name: Fix perms, optional deps, restart Odoo
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          ODOO_SERVICE:    ${{ secrets.ODOO_SERVICE }}
          ODOO_CONFIG_PATH: ${{ secrets.ODOO_CONFIG_PATH }}
          UAT_DB_NAME:     ${{ secrets.UAT_DB_NAME }}
        run: |
          set -e
          env -u SSH_AUTH_SOCK ssh -F "$HOME/.ssh/config" target bash -lc '
            set -e
            chown -R root:root /opt/swituat/custom-addons

            if [ -f /opt/swituat/custom-addons/requirements.txt ]; then
              pip3 install -r /opt/swituat/custom-addons/requirements.txt
            fi

            # Optional: auto-update modules (fill names comma-separated)
            AUTO_UPDATE=""
            if [ -n "$AUTO_UPDATE" ]; then
              /usr/bin/odoo -c "${ODOO_CONFIG_PATH:-/etc/swituat.conf}" -d "${UAT_DB_NAME}" -u "$AUTO_UPDATE" --stop-after-init
            fi

            systemctl restart "${ODOO_SERVICE}"
            systemctl is-active "${ODOO_SERVICE}"
          '
